import { useState, useEffect, useRef } from "react";
import { REC, EXP } from "../data/eldiItems.js";
import { ELDI_IMAGES } from "../data/eldiImages.js";

const K = { mt: "#64748b" };
const gm=(b,e)=>{const B=new Date(b),E=new Date(e);let m=(E.getFullYear()-B.getFullYear())*12+E.getMonth()-B.getMonth();if(E.getDate()&lt;B.getDate())m--;return Math.max(0,m)};
const fa=m=>`${Math.floor(m/12)} a\u00f1os, ${m%12} meses`;

const scrollTop=()=>{
  const el=document.getElementById("main-scroll");
  if(el)el.scrollTo({top:0,behavior:"smooth"});
  else window.scrollTo({top:0,behavior:"smooth"});
};

const BANDS=[
  {min:0,max:5,label:"0;0\u20130;5"},{min:6,max:11,label:"0;6\u20130;11"},
  {min:12,max:17,label:"1;0\u20131;5"},{min:18,max:23,label:"1;6\u20131;11"},
  {min:24,max:29,label:"2;0\u20132;5"},{min:30,max:35,label:"2;6\u20132;11"},
  {min:36,max:41,label:"3;0\u20133;5"},{min:42,max:47,label:"3;6\u20133;11"},
  {min:48,max:59,label:"4;0\u20134;11"},{min:60,max:71,label:"5;0\u20135;11"},
  {min:72,max:95,label:"6;0\u20137;11"}
];
function getBandIndex(ageMo){for(let i=BANDS.length-1;i>=0;i--){if(ageMo>=BANDS[i].min)return i;}return 0;}

function calcScoring(items, rsp, ageMo){
  const bandIdx=getBandIndex(ageMo);
  const expectedCount=(bandIdx+1)*5;
  const expectedItems=items.slice(0,expectedCount);
  let logrado=0,noLogrado=0,noEvaluado=[];
  items.forEach(i=>{const v=rsp[i.id];if(v===true)logrado++;else if(v===false)noLogrado++;else noEvaluado.push(i.id);});
  let logradoExpected=0;
  expectedItems.forEach(i=>{if(rsp[i.id]===true)logradoExpected++;});
  let devAgeBandIdx=-1;
  for(let b=0;b&lt;BANDS.length;b++){
    const bandItems=items.slice(b*5,b*5+5);
    const passed=bandItems.filter(i=>rsp[i.id]===true).length;
    if(passed>=4)devAgeBandIdx=b;else break;
  }
  const devAgeLabel=devAgeBandIdx>=0?BANDS[devAgeBandIdx].label:null;
  const pctExpected=expectedCount>0?Math.round(logradoExpected/expectedCount*100):null;
  let classification=null,classColor=null;
  if(pctExpected!==null){
    if(pctExpected>=90){classification="Dentro de L\u00edmites Normales";classColor="#059669";}
    else if(pctExpected>=75){classification="En Riesgo / Retraso Leve";classColor="#f59e0b";}
    else if(pctExpected>=50){classification="Retraso Moderado";classColor="#ea580c";}
    else{classification="Retraso Significativo";classColor="#dc2626";}
  }
  return{logrado,noLogrado,noEvaluado,total:items.length,evaluados:logrado+noLogrado,
    pctLogrado:(logrado+noLogrado)>0?Math.round(logrado/(logrado+noLogrado)*100):null,
    expectedCount,logradoExpected,pctExpected,devAgeBandIdx,devAgeLabel,
    classification,classColor};
}

function SequenceGame(){
  const imgs=[
    {id:1,label:"Corre hacia la pelota",emoji:"\ud83c\udfc3\u200d\u2642\ufe0f\u27a1\ufe0f\u26bd"},
    {id:2,label:"Patea la pelota",emoji:"\ud83e\uddb5\u26bd"},
    {id:3,label:"La pelota vuela",emoji:"\u26bd\ud83d\udca8"}
  ];
  const[order,setOrder]=useState([3,1,2]);
  const[dragging,setDragging]=useState(null);
  const correct=order[0]===1&amp;&amp;order[1]===2&amp;&amp;order[2]===3;
  const swap=(from,to)=>{const n=[...order];const t=n[from];n[from]=n[to];n[to]=t;setOrder(n);};
  return&lt;div style={{padding:16,background:"#f8faf9",borderRadius:10,border:"1px solid #e2e8f0"}}>
    &lt;div style={{fontSize:13,fontWeight:600,color:"#0a3d2f",marginBottom:10}}>Orden\u00e1 las im\u00e1genes en secuencia correcta:&lt;/div>
    &lt;div style={{display:"flex",gap:10,justifyContent:"center",flexWrap:"wrap"}}>
      {order.map((imgId,idx)=>{const img=imgs.find(i=>i.id===imgId);
        return&lt;div key={idx} draggable onDragStart={()=>setDragging(idx)} onDragOver={e=>e.preventDefault()}
          onDrop={()=>{if(dragging!==null){swap(dragging,idx);setDragging(null)}}}
          style={{width:120,padding:12,background:"#fff",border:`2px solid ${correct?"#059669":"#e2e8f0"}`,borderRadius:10,textAlign:"center",cursor:"grab",userSelect:"none"}}>
          &lt;div style={{fontSize:32}}>{img.emoji}&lt;/div>
          &lt;div style={{fontSize:11,color:"#475569",marginTop:4}}>{img.label}&lt;/div>
          &lt;div style={{fontSize:10,color:"#94a3b8",marginTop:2}}>Paso {idx+1}&lt;/div>
        &lt;/div>})}
    &lt;/div>
    {correct&amp;&amp;&lt;div style={{marginTop:10,textAlign:"center",color:"#059669",fontWeight:700,fontSize:13}}>\u00a1Orden correcto!&lt;/div>}
    {!correct&amp;&amp;&lt;div style={{marginTop:8,textAlign:"center",fontSize:11,color:"#94a3b8"}}>Arrastr\u00e1 y solt\u00e1 para reordenar&lt;/div>}
  &lt;/div>;
}
