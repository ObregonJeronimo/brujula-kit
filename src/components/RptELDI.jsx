import { useState } from "react";
const K = { mt: "#64748b" };
const itp=s=>s>=115?{t:"Superior al promedio",c:"#059669"}:s>=86?{t:"Dentro del promedio",c:"#2563eb"}:s>=78?{t:"Riesgo - Desfase leve",c:"#d97706"}:{t:"D√©ficit significativo",c:"#dc2626"};
const fa=m=>`${Math.floor(m/12)} a√±os, ${m%12} meses`;
const ssToAgeEq=ss=>ss<=55?"<0;3":ss<=70?"Desfase significativo":ss<=85?"Desfase leve":ss<=115?"Acorde a edad":"Superior a edad";

export default function RptELDI({ev,isA,onD}){
  const ri=itp(ev.ssReceptivo),ei=itp(ev.ssExpresivo),ti=itp(ev.ssTotal);
  const[cd,sCD]=useState(false);
  const pdf=()=>{const w=window.open("","_blank");if(!w)return;w.document.write(`<!DOCTYPE html><html><head><title>ELDI ${ev.paciente}</title><style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Segoe UI',Arial,sans-serif;color:#1e293b;padding:24px 36px;max-width:800px;margin:0 auto;line-height:1.5}h1{font-size:22px;color:#0a3d2f;border-bottom:3px solid #0d9488;padding-bottom:8px;margin-bottom:18px}h2{font-size:14px;color:#0a3d2f;margin:12px 0 6px;text-transform:uppercase;letter-spacing:.5px}.g{display:grid;grid-template-columns:1fr 1fr;gap:6px 24px}.f{font-size:13px;padding:6px 0;border-bottom:1px solid #f1f5f9}.f strong{color:#475569}table{width:100%;border-collapse:collapse;margin:12px 0}th,td{border:1px solid #e2e8f0;padding:10px 14px;text-align:center;font-size:13px}th{background:#0a3d2f;color:white}.ip{padding:8px 12px;border-radius:6px;font-size:13px;font-weight:600;margin:10px 0}.ob{background:#f8faf9;padding:10px;border-radius:6px;border:1px solid #e2e8f0;font-size:13px;min-height:50px;margin:8px 0}.ft{margin-top:20px;border-top:1px solid #e2e8f0;padding-top:20px;display:flex;justify-content:space-between}.sg{text-align:center;width:44%}.sg .ln{border-top:1px solid #1e293b;margin-top:30px;padding-top:4px;font-size:12px}</style></head><body><div style="text-align:center;margin-bottom:28px"><h1 style="border:none;font-size:24px">INFORME ELDI</h1><p style="color:#64748b;font-size:13px">Evaluaci√≥n del Lenguaje y Desarrollo Infantil ‚Äî Br√∫jula KIT</p></div><h2>1. Identificaci√≥n</h2><div class="g"><div class="f"><strong>Nombre:</strong> ${ev.paciente}</div><div class="f"><strong>Edad:</strong> ${fa(ev.edadMeses)}</div><div class="f"><strong>F.nac:</strong> ${ev.fechaNacimiento}</div><div class="f"><strong>F.eval:</strong> ${ev.fechaEvaluacion}</div><div class="f"><strong>Establ:</strong> ${ev.establecimiento||"‚Äî"}</div><div class="f"><strong>Derivado:</strong> ${ev.derivadoPor||"‚Äî"}</div></div><h2>2. Resultados</h2><table><tr><th>Escala</th><th>Bruto</th><th>Est√°ndar</th><th>Pctil</th><th>Nivel</th><th>Interp.</th></tr><tr><td>Comp. Auditiva</td><td>${ev.brutoReceptivo}</td><td>${ev.ssReceptivo}</td><td>${ev.pcReceptivo}%</td><td>${ev.aeReceptivo}</td><td style="color:${ri.c};font-weight:600">${ri.t}</td></tr><tr><td>Com. Expresiva</td><td>${ev.brutoExpresivo}</td><td>${ev.ssExpresivo}</td><td>${ev.pcExpresivo}%</td><td>${ev.aeExpresivo}</td><td style="color:${ei.c};font-weight:600">${ei.t}</td></tr><tr style="font-weight:700"><td>Total</td><td>${ev.brutoReceptivo+ev.brutoExpresivo}</td><td>${ev.ssTotal}</td><td>${ev.pcTotal}%</td><td>‚Äî</td><td style="color:${ti.c}">${ti.t}</td></tr></table><h2>3. Interpretaci√≥n</h2><div class="ip" style="background:${ti.c}15;color:${ti.c};border-left:4px solid ${ti.c}">${ti.t} (PE=${ev.ssTotal}, Pctil ${ev.pcTotal}%)</div><h2>4. Observaciones</h2><div class="ob">${ev.observaciones||"Sin observaciones."}</div><h2>5. Recomendaciones</h2><div class="ob">${ev.ssTotal>=86?"Rendimiento esperado. Seguimiento sugerido.":"Se sugiere intervenci√≥n fonoaudiol√≥gica. Reevaluaci√≥n en 6 meses."}</div><div class="ft"><div class="sg"><div class="ln">Firma Profesional</div><p style="font-size:11px;color:#64748b">Fonoaudi√≥logo/a</p></div><div class="sg"><div class="ln">Fecha</div><p style="font-size:11px;color:#64748b">${new Date(ev.fechaGuardado).toLocaleDateString("es-CL")}</p></div></div></body></html>`);w.document.close();setTimeout(()=>w.print(),500)};
  return(<div style={{width:"100%",maxWidth:900,animation:"fi .3s ease"}}>
    <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:24,flexWrap:"wrap",gap:12}}>
      <div><h1 style={{fontSize:24,fontWeight:700}}>Informe ELDI</h1><p style={{color:K.mt,fontSize:15,marginTop:2}}>{ev.paciente} ‚Äî {fa(ev.edadMeses)}</p></div>
      <div style={{display:"flex",gap:8}}>
        {isA&&(cd?<div style={{display:"flex",gap:4,alignItems:"center"}}><button onClick={()=>{onD(ev._fbId,"evaluaciones");sCD(false)}} style={{background:"#dc2626",color:"#fff",border:"none",padding:"8px 16px",borderRadius:6,fontSize:12,fontWeight:600,cursor:"pointer"}}>S√≠, eliminar</button><button onClick={()=>sCD(false)} style={{background:"#f1f5f9",border:"none",padding:"8px 16px",borderRadius:6,fontSize:12,cursor:"pointer"}}>No</button></div>:<button onClick={()=>sCD(true)} style={{background:"#fef2f2",color:"#dc2626",border:"1px solid #fecaca",padding:"8px 16px",borderRadius:8,fontSize:13,cursor:"pointer"}}>üóë Eliminar</button>)}
        <button onClick={pdf} style={{background:"#dc2626",color:"#fff",border:"none",padding:"11px 22px",borderRadius:8,fontSize:14,fontWeight:600,cursor:"pointer"}}>üìÑ Exportar PDF</button>
      </div>
    </div>
    <div style={{background:"#fff",borderRadius:14,padding:32,border:"1px solid #e2e8f0"}}>
      <h3 style={{fontSize:16,fontWeight:700,color:"#0a3d2f",marginBottom:14,paddingBottom:8,borderBottom:"2px solid #ccfbf1"}}>Datos del Paciente</h3>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px 32px",marginBottom:28}}>{[["Nombre",ev.paciente],["Edad",fa(ev.edadMeses)],["F. nacimiento",ev.fechaNacimiento],["F. evaluaci√≥n",ev.fechaEvaluacion],["Establecimiento",ev.establecimiento||"‚Äî"],["Derivado por",ev.derivadoPor||"‚Äî"]].map(([l,v],i)=><div key={i} style={{padding:"8px 0",borderBottom:"1px solid #f1f5f9"}}><div style={{fontSize:11,color:K.mt,marginBottom:3,textTransform:"uppercase"}}>{l}</div><div style={{fontSize:15,fontWeight:600}}>{v}</div></div>)}</div>
      <h3 style={{fontSize:16,fontWeight:700,color:"#0a3d2f",marginBottom:14,paddingBottom:8,borderBottom:"2px solid #ccfbf1"}}>Resultados</h3>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:14}}>{[["üîä Comp. Auditiva",ev.brutoReceptivo,ev.ssReceptivo,ev.pcReceptivo,ri],["üó£Ô∏è Com. Expresiva",ev.brutoExpresivo,ev.ssExpresivo,ev.pcExpresivo,ei]].map(([lb,raw,ss,pc,ip],i)=><div key={i} style={{background:"#f8faf9",borderRadius:10,padding:20,border:"1px solid #e2e8f0"}}><div style={{fontWeight:700,fontSize:14,marginBottom:14}}>{lb}</div><div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:10}}>{[["Bruto",raw],["Est√°ndar",ss],["Pctil",pc+"%"],["Nivel",i===0?ev.aeReceptivo:ev.aeExpresivo]].map(([l,v],j)=><div key={j}><div style={{fontSize:10,color:K.mt,marginBottom:3}}>{l}</div><div style={{fontSize:20,fontWeight:700}}>{v}</div></div>)}</div><div style={{marginTop:12,display:"inline-flex",alignItems:"center",gap:6,padding:"4px 12px",borderRadius:14,background:ip.c+"15",color:ip.c,fontSize:12,fontWeight:600}}><span style={{width:7,height:7,borderRadius:"50%",background:ip.c}}/>{ip.t}</div></div>)}</div>
      <div style={{background:"linear-gradient(135deg,#0a3d2f,#0d9488)",borderRadius:10,padding:24,color:"#fff",marginBottom:28}}><div style={{fontSize:13,opacity:.8,marginBottom:8}}>Total</div><div style={{display:"flex",alignItems:"baseline",gap:16}}><span style={{fontSize:48,fontWeight:700}}>{ev.ssTotal}</span><div><div style={{fontSize:15}}>Percentil: {ev.pcTotal}%</div><div style={{marginTop:4,display:"inline-flex",padding:"4px 14px",borderRadius:14,background:"rgba(255,255,255,.18)",fontSize:14,fontWeight:600}}>‚óè {ti.t}</div></div></div></div>
      <h3 style={{fontSize:16,fontWeight:700,color:"#0a3d2f",marginBottom:10,paddingBottom:8,borderBottom:"2px solid #ccfbf1"}}>Observaciones</h3>
      <div style={{background:"#f8faf9",padding:18,borderRadius:10,fontSize:14,border:"1px solid #e2e8f0",lineHeight:1.7,minHeight:60}}>{ev.observaciones||"Sin observaciones."}</div>
    </div>
  </div>);
}
