import { useState } from "react";

const K = { mt: "#64748b" };
const gm=(b,e)=>{const B=new Date(b),E=new Date(e);let m=(E.getFullYear()-B.getFullYear())*12+E.getMonth()-B.getMonth();if(E.getDate()<B.getDate())m--;return Math.max(0,m)};
const fa=m=>`${Math.floor(m/12)} aÃ±os, ${m%12} meses`;
const NM={"0-5":[{n:0,x:1,s:55},{n:2,x:3,s:70},{n:4,x:5,s:85},{n:6,x:7,s:100},{n:8,x:9,s:115},{n:10,x:99,s:130}],"6-11":[{n:0,x:2,s:55},{n:3,x:5,s:70},{n:6,x:8,s:85},{n:9,x:12,s:100},{n:13,x:16,s:115},{n:17,x:99,s:130}],"12-17":[{n:0,x:4,s:55},{n:5,x:8,s:70},{n:9,x:12,s:85},{n:13,x:17,s:100},{n:18,x:22,s:115},{n:23,x:99,s:130}],"18-23":[{n:0,x:6,s:55},{n:7,x:10,s:70},{n:11,x:15,s:85},{n:16,x:22,s:100},{n:23,x:28,s:115},{n:29,x:99,s:130}],"24-29":[{n:0,x:8,s:55},{n:9,x:13,s:70},{n:14,x:18,s:85},{n:19,x:26,s:100},{n:27,x:33,s:115},{n:34,x:99,s:130}],"30-35":[{n:0,x:10,s:55},{n:11,x:16,s:70},{n:17,x:22,s:85},{n:23,x:30,s:100},{n:31,x:37,s:115},{n:38,x:99,s:130}],"36-41":[{n:0,x:12,s:55},{n:13,x:18,s:70},{n:19,x:25,s:85},{n:26,x:34,s:100},{n:35,x:41,s:115},{n:42,x:99,s:130}],"42-47":[{n:0,x:14,s:55},{n:15,x:20,s:70},{n:21,x:28,s:85},{n:29,x:38,s:100},{n:39,x:45,s:115},{n:46,x:99,s:130}],"48-59":[{n:0,x:16,s:55},{n:17,x:24,s:70},{n:25,x:32,s:85},{n:33,x:42,s:100},{n:43,x:49,s:115},{n:50,x:99,s:130}],"60-71":[{n:0,x:20,s:55},{n:21,x:28,s:70},{n:29,x:36,s:85},{n:37,x:46,s:100},{n:47,x:52,s:115},{n:53,x:99,s:130}],"72-95":[{n:0,x:24,s:55},{n:25,x:32,s:70},{n:33,x:40,s:85},{n:41,x:49,s:100},{n:50,x:53,s:115},{n:54,x:99,s:130}]};
const gp=m=>m<6?"0-5":m<12?"6-11":m<18?"12-17":m<24?"18-23":m<30?"24-29":m<36?"30-35":m<42?"36-41":m<48?"42-47":m<60?"48-59":m<72?"60-71":"72-95";
const rawToSS=(r,m)=>{const t=NM[gp(m)];for(const v of t)if(r>=v.n&&r<=v.x)return v.s;return t[t.length-1].s};
const ssToAgeEq=ss=>ss<=55?"<0;3":ss<=70?"Desfase significativo":ss<=85?"Desfase leve":ss<=115?"Acorde a edad":"Superior a edad";
const itp=s=>s>=115?{t:"Superior al promedio",c:"#059669"}:s>=86?{t:"Dentro del promedio",c:"#2563eb"}:s>=78?{t:"Riesgo - Desfase leve",c:"#d97706"}:{t:"DÃ©ficit significativo",c:"#dc2626"};
function normalCDF(x){const a1=.254829592,a2=-.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=.3275911;const s=x<0?-1:1;x=Math.abs(x)/Math.sqrt(2);const t=1/(1+p*x);const y=1-(((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);return .5*(1+s*y);}
function ssToPercentile(ss){return Math.round(normalCDF((ss-100)/15)*1000)/10;}

import { REC, EXP } from "../data/eldiItems.js";

export default function NewELDI({onS,nfy}){
  const[step,sS]=useState(1),[pd,sPd]=useState({pN:"",birth:"",eD:new Date().toISOString().split("T")[0],sch:"",ref:"",obs:""}),[rsp,sR]=useState({}),[showEx,setEx]=useState({});
  const a=pd.birth&&pd.eD?gm(pd.birth,pd.eD):0;
  const tog=id=>sR(p=>{const v=p[id];if(v===undefined)return{...p,[id]:true};if(v===true)return{...p,[id]:false};const n={...p};delete n[id];return n});
  const rR=Object.entries(rsp).filter(([k,v])=>k.startsWith("AC")&&v===true).length;
  const rE=Object.entries(rsp).filter(([k,v])=>k.startsWith("EC")&&v===true).length;
  const I={width:"100%",padding:"10px 14px",border:"1px solid #e2e8f0",borderRadius:8,fontSize:14,background:"#f8faf9"};
  const Bt=({children,onClick,pr})=><button onClick={onClick} style={{background:pr?"#0d9488":"#f1f5f9",color:pr?"#fff":"#1e293b",border:"none",padding:"10px 22px",borderRadius:8,fontSize:14,fontWeight:600,cursor:"pointer"}}>{children}</button>;
  const RI=(items,prefix)=>{const gr={};items.forEach(i=>{if(!gr[i.a])gr[i.a]=[];gr[i.a].push(i)});
    return(<div><h2 style={{fontSize:18,fontWeight:700,marginBottom:4}}>{prefix==="AC"?"ğŸ”Š ComprensiÃ³n Auditiva":"ğŸ—£ï¸ ComunicaciÃ³n Expresiva"}</h2><p style={{color:K.mt,fontSize:13,marginBottom:16}}>1 click = âœ” OK Â· 2 clicks = âœ˜ No logrado Â· 3 clicks = Sin evaluar</p>
      {Object.entries(gr).map(([range,gi])=><div key={range} style={{marginBottom:18}}><div style={{background:"#ccfbf1",padding:"6px 12px",borderRadius:6,fontSize:12,fontWeight:600,color:"#0d9488",marginBottom:8}}>Edad: {range}</div>
        {gi.map(item=>{const v=rsp[item.id];const exO=showEx[item.id];return(<div key={item.id} style={{marginBottom:3}}>
          <div onClick={()=>tog(item.id)} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:exO?"8px 8px 0 0":8,cursor:"pointer",background:v===true?"#ecfdf5":v===false?"#fef2f2":"#fff",border:`1px solid ${v===true?"#a7f3d0":v===false?"#fecaca":"#e2e8f0"}`,borderBottom:exO?"none":undefined}}>
            <div style={{width:28,height:28,borderRadius:6,display:"flex",alignItems:"center",justifyContent:"center",background:v===true?"#059669":v===false?"#dc2626":"#e2e8f0",color:"#fff",fontSize:13,fontWeight:700,flexShrink:0}}>{v===true?"âœ“":v===false?"âœ—":"â€”"}</div>
            <span style={{fontWeight:600,fontSize:12,color:"#64748b",minWidth:36}}>{item.id}</span><span style={{fontSize:13,flex:1}}>{item.l}</span>
            <button onClick={e=>{e.stopPropagation();setEx(p=>({...p,[item.id]:!p[item.id]}))}} style={{background:"none",border:"1px solid #e2e8f0",borderRadius:4,padding:"2px 8px",fontSize:11,color:"#64748b",cursor:"pointer",flexShrink:0}}>{exO?"ocultar":"ver ejemplo"}</button>
          </div>
          {exO&&<div style={{background:"#f0fdf4",padding:"8px 14px 8px 52px",borderRadius:"0 0 8px 8px",border:"1px solid #e2e8f0",borderTop:"none",fontSize:12,color:"#16a34a",fontStyle:"italic"}}>ğŸ’¡ {item.ej}</div>}
        </div>)})}</div>)}</div>)};
  return(<div style={{width:"100%",maxWidth:800,animation:"fi .3s ease"}}>
    <div style={{display:"flex",gap:4,marginBottom:22}}>{["Paciente","Receptivo","Expresivo","Resultado"].map((s,i)=><div key={i} style={{flex:1,textAlign:"center"}}><div style={{height:4,borderRadius:2,marginBottom:5,background:step>i?"#0d9488":step===i+1?"#b2dfdb":"#e2e8f0"}}/><span style={{fontSize:11,color:step===i+1?"#0d9488":"#64748b",fontWeight:step===i+1?600:400}}>{s}</span></div>)}</div>
    <div style={{background:"#fff",borderRadius:12,padding:28,border:"1px solid #e2e8f0"}}>
      {step===1&&<div><h2 style={{fontSize:18,fontWeight:700,marginBottom:4}}>ğŸ“‹ ELDI â€” Datos del Paciente</h2><p style={{color:K.mt,fontSize:13,marginBottom:20}}>EvaluaciÃ³n del Lenguaje y Desarrollo Infantil</p>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}><div style={{gridColumn:"1/-1"}}><label style={{fontSize:12,fontWeight:600,color:K.mt,display:"block",marginBottom:4}}>Nombre completo</label><input value={pd.pN} onChange={e=>sPd(p=>({...p,pN:e.target.value}))} style={I} placeholder="Nombre y apellido"/></div><div><label style={{fontSize:12,fontWeight:600,color:K.mt,display:"block",marginBottom:4}}>Fecha nacimiento</label><input type="date" value={pd.birth} onChange={e=>sPd(p=>({...p,birth:e.target.value}))} style={I}/></div><div><label style={{fontSize:12,fontWeight:600,color:K.mt,display:"block",marginBottom:4}}>Fecha evaluaciÃ³n</label><input type="date" value={pd.eD} onChange={e=>sPd(p=>({...p,eD:e.target.value}))} style={I}/></div><div><label style={{fontSize:12,fontWeight:600,color:K.mt,display:"block",marginBottom:4}}>Establecimiento</label><input value={pd.sch} onChange={e=>sPd(p=>({...p,sch:e.target.value}))} style={I} placeholder="JardÃ­n / Colegio"/></div><div><label style={{fontSize:12,fontWeight:600,color:K.mt,display:"block",marginBottom:4}}>Derivado por</label><input value={pd.ref} onChange={e=>sPd(p=>({...p,ref:e.target.value}))} style={I} placeholder="Profesional"/></div></div>
        {a>0&&<div style={{marginTop:14,padding:"10px 16px",background:"#ccfbf1",borderRadius:8,fontSize:14}}><strong>Edad:</strong> {fa(a)} ({a} meses)</div>}
        <div style={{display:"flex",justifyContent:"flex-end",marginTop:20}}><Bt pr onClick={()=>{if(!pd.pN||!pd.birth){nfy("Complete nombre y fecha","er");return}sS(2)}}>Siguiente â†’</Bt></div></div>}
      {step===2&&<div>{RI(REC,"AC")}<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:14,paddingTop:14,borderTop:"1px solid #e2e8f0"}}><span style={{fontSize:13,color:K.mt}}>Logrados: <b style={{color:"#0d9488"}}>{rR}</b>/55</span><div style={{display:"flex",gap:8}}><Bt onClick={()=>sS(1)}>â† AtrÃ¡s</Bt><Bt pr onClick={()=>sS(3)}>Siguiente â†’</Bt></div></div></div>}
      {step===3&&<div>{RI(EXP,"EC")}<div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:14,paddingTop:14,borderTop:"1px solid #e2e8f0"}}><span style={{fontSize:13,color:K.mt}}>Logrados: <b style={{color:"#0d9488"}}>{rE}</b>/55</span><div style={{display:"flex",gap:8}}><Bt onClick={()=>sS(2)}>â† AtrÃ¡s</Bt><Bt pr onClick={()=>sS(4)}>Resultados â†’</Bt></div></div></div>}
      {step===4&&(()=>{const ssR=rawToSS(rR,a),ssE2=rawToSS(rE,a),ssT=Math.round((ssR+ssE2)/2),pcR=ssToPercentile(ssR),pcE=ssToPercentile(ssE2),pcT=ssToPercentile(ssT);
        return<div><h2 style={{fontSize:20,fontWeight:700,marginBottom:20}}>Resultados ELDI â€” {pd.pN}</h2>
          {[["ğŸ”Š ComprensiÃ³n Auditiva",rR,ssR,pcR],["ğŸ—£ï¸ Com. Expresiva",rE,ssE2,pcE]].map(([lb,raw,ss,pc],i)=>{const ip=itp(ss);return<div key={i} style={{background:"#f8faf9",borderRadius:10,padding:20,border:"1px solid #e2e8f0",marginBottom:12}}><div style={{fontWeight:700,fontSize:15,marginBottom:12}}>{lb}</div><div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12}}>{[["Bruto",`${raw}/55`],["EstÃ¡ndar",ss],["Percentil",`${pc}%`],["Nivel",ssToAgeEq(ss)]].map(([l,v],j)=><div key={j}><div style={{fontSize:11,color:K.mt,marginBottom:2}}>{l}</div><div style={{fontSize:20,fontWeight:700}}>{v}</div></div>)}</div><div style={{marginTop:10,display:"inline-flex",alignItems:"center",gap:6,padding:"4px 12px",borderRadius:16,background:ip.c+"15",color:ip.c,fontSize:13,fontWeight:600}}><span style={{width:8,height:8,borderRadius:"50%",background:ip.c}}/>{ip.t}</div></div>})}
          <div style={{background:"linear-gradient(135deg,#0a3d2f,#0d9488)",borderRadius:10,padding:24,color:"#fff",marginBottom:24}}><div style={{fontSize:13,opacity:.8,marginBottom:8}}>Puntaje Total</div><div style={{display:"flex",alignItems:"baseline",gap:14}}><span style={{fontSize:44,fontWeight:700}}>{ssT}</span><span style={{fontSize:15,opacity:.8}}>Percentil: {pcT}%</span></div><div style={{marginTop:8,display:"inline-flex",padding:"5px 14px",borderRadius:16,background:"rgba(255,255,255,.18)",fontSize:14,fontWeight:600}}>â— {itp(ssT).t}</div></div>
          <div style={{marginBottom:20}}><label style={{fontSize:13,fontWeight:600,color:K.mt,display:"block",marginBottom:6}}>Observaciones</label><textarea value={pd.obs} onChange={e=>sPd(p=>({...p,obs:e.target.value}))} rows={4} style={{width:"100%",padding:"12px 14px",border:"1px solid #e2e8f0",borderRadius:8,fontSize:14,resize:"vertical",background:"#f8faf9"}} placeholder="Observaciones clÃ­nicas..."/></div>
          <div style={{display:"flex",justifyContent:"space-between"}}><Bt onClick={()=>sS(3)}>â† AtrÃ¡s</Bt><button onClick={()=>onS({...pd,a,rsp,rR,rE})} style={{background:"#0d9488",color:"#fff",border:"none",padding:"12px 28px",borderRadius:8,fontSize:15,fontWeight:700,cursor:"pointer"}}>ğŸ’¾ Guardar</button></div>
        </div>})()}
    </div>
  </div>);
}
